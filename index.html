<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Todos/Goals</title>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/redux/3.7.2/redux.min.js'></script>
    <script src='https://unpkg.com/react@16.3.0-alpha.1/umd/react.development.js'></script>
    <script src='https://unpkg.com/react-dom@16.3.0-alpha.1/umd/react-dom.development.js'></script>
    <script src='https://unpkg.com/babel-standalone@6.15.0/babel.min.js'></script>
  </head>
  <body>
    <h5><em>VANNILA JS APPLICATION</em></h5>

    <div>
      <h1>Todo List</h1>
      <input type='text' id='todo' placeholder='Add Todo'>
      <button id='todoBtn'>Add Todo</button>
      <ul id='todos'></ul>
    </div>

    <div>
      <h1>Goals</h1>
      <input type='text' id='goal' placeholder='Add Goal'>
      <button id='goalBtn'>Add Goal</button>
      <ul id='goals'></ul>
    <div>

    <hr>

    <div id='app'></div>

    <script type="text/javascript">
      /***** Library Code *****/

      function generateUID() {
        return  Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15)
      }

      // --- Now handled by Redux
      function createStore(reducer) {
      	// The store should have four parts:
      	// 1. The state.
      	// 2. A way to get the state.
      	// 3. A way to listen to changes on the state.
      	// 4. A way to update the state.

      	let state

      	let listeners = []

      	const getState = () => state

      	const subscribe = (listener) => {
      		listeners.push(listener)

      		return () => {
      			listeners = listeners.filter((l) => l !== listener)
      		}
      	}

      	const dispatch = (action) => {
      		state = reducer(state, action)
      		listeners.forEach((listener) => listener())
      	}

      	return {
      		getState,
      		subscribe,
      		dispatch,
      	}
      }

      /***** App Code *****/

      // App constants
      const ADD_TODO = 'ADD_TODO'
      const REMOVE_TODO = 'REMOVE_TODO'
      const TOGGLE_TODO = 'TOGGLE_TODO'
      const ADD_GOAL = 'ADD_GOAL'
      const REMOVE_GOAL = 'REMOVE_GOAL'

      // Action creators
      function addTodoAction(todo) {
      	return {
      		type: ADD_TODO,
      		todo,
      	}
      }

      function removeTodoAction(id) {
      	return {
      		type: REMOVE_TODO,
      		id,
      	}
      }

      function toggleTodoAction(id) {
      	return {
      		type: TOGGLE_TODO,
      		id,
      	}
      }

      function addGoalAction(goal) {
      	return {
      		type: ADD_GOAL,
      		goal,
      	}
      }

      function removeGoalAction(id) {
      	return {
      		type: REMOVE_GOAL,
      		id,
      	}
      }

      const checker = (store) => (next) => (action) => {
        if(action.type === ADD_TODO && action.todo.name.toLowerCase().indexOf('bitcoin') != -1) {
          return alert('That\'s not a totally bad idea, but you should consider Ethereum instead.')
        }

        if(action.type === ADD_GOAL && action.goal.name.toLowerCase().indexOf('bitcoin') != -1) {
          return alert('That\'s not a totally bad idea, but you should consider Ethereum instead.')
        }

        return next(action)
      }

      const logger = (store) => (next) => (action) => {
        console.group(action.type)
        console.log('The action: ', action)
        const result = next(action)
        console.log('The new state: ', store.getState())
        console.groupEnd()

        return result
      }

      // Reducer function - Todos
      function todos(state = [], action) {

      	switch (action.type) {
      		case ADD_TODO:
      			return state.concat([action.todo])
      		case REMOVE_TODO:
      			return state.filter((todo) => todo.id !== action.id)
      		case TOGGLE_TODO:
      			return state.map((todo) => todo.id !== action.id ? todo : Object.assign({}, todo, {
      				complete: !todo.complete
      			}))
      		default:
      			return state
      	}

      }

      // Reducer function - Goals
      function goals(state = [], action) {

      	switch (action.type) {
      		case ADD_GOAL:
      			return state.concat([action.goal])
      		case REMOVE_GOAL:
      			return state.filter((goal) => goal.id !== action.id)
      		default:
      			return state
      	}

      }

      // Root reducer function --- Now handled by Redux
      function app(state = {}, action) {

      	return {
      		todos: todos(state.todos, action),
      		goals: goals(state.goals, action),
      	}

      }

      const store = Redux.createStore(Redux.combineReducers({
        todos,
        goals,
      }), Redux.applyMiddleware(checker, logger));
      store.subscribe(() => {
        const {todos, goals} = store.getState()

        document.getElementById('todos').innerHTML = ''
        document.getElementById('goals').innerHTML = ''

        todos.forEach(addTodoToDom)
        goals.forEach(addGoalToDom)
      })

      /***** Dom Code *****/

      function createRemoveButton(onClick) {
        const removeBtn = document.createElement('button')
        removeBtn.innerHTML = 'X'

        removeBtn.addEventListener('click', onClick)

        return removeBtn
      }

      function addTodoToDom(todo) {
        const node = document.createElement('li')
        const text = document.createTextNode(todo.name + ' ')
        const removeBtn = createRemoveButton(() => {
          store.dispatch(removeTodoAction(todo.id))
        })

        node.appendChild(text)
        node.appendChild(removeBtn)

        node.style.textDecoration = todo.complete ? 'line-through' : 'none'
        node.addEventListener('click', () => {
          store.dispatch(toggleTodoAction(todo.id))
        })

        document.getElementById('todos')
          .appendChild(node)
      }

      function addGoalToDom(goal) {
        const node = document.createElement('li')
        const text = document.createTextNode(goal.name)
        const removeBtn = createRemoveButton(() => {
          store.dispatch(removeGoalAction(goal.id))
        })

        node.appendChild(text)
        node.appendChild(removeBtn)

        document.getElementById('goals')
          .appendChild(node)
      }

      function addTodo() {
        const input = document.getElementById('todo')
        const name = input.value
        input.value = ''

        store.dispatch(addTodoAction({
          id: generateUID(),
          name,
          complete: false,
        }))
      }

      function addGoal() {
        const input = document.getElementById('goal')
        const name = input.value
        input.value = ''

        store.dispatch(addGoalAction({
          id: generateUID(),
          name,
        }))
      }

      document.getElementById('todoBtn')
        .addEventListener('click', addTodo)

      document.getElementById('goalBtn')
        .addEventListener('click', addGoal)
    </script>

    <script type='text/babel'>

      const List = (props) => {
        return (
          <ul>
            <li>item</li>
          </ul>
        )
      }

      class Todos extends React.Component {
        render() {
          return (
            <div>
              <h1>Todo List</h1>
              <input
                type='text'
                placeholder='Add Todo'
                />
              <button>Add Todo</button>

              <List />
            </div>
          )
        }
      }

      class Goals extends React.Component {
        render() {
          return (
            <div>
              <h1>Goals</h1>
              <input
                type='text'
                placeholder='Add Goal'
                />
              <button>Add Goal</button>

              <List />
            </div>
          )
        }
      }

      class App extends React.Component {
        render() {
          return (
            <div>
              <h5><em>REACT APPLICATION</em></h5>
              <Todos />
              <Goals />
            </div>
          )
        }
      }

      ReactDOM.render(<App />, document.getElementById('app'))

    </script>
  </body>
</html>
